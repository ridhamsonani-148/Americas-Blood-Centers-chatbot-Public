<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="America's Blood Centers Admin Dashboard"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>Admin Dashboard - America's Blood Centers</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="admin-root"></div>
    
    <!-- Load React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Material-UI from CDN -->
    <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.production.min.js"></script>
    
    <!-- Admin App Script -->
    <script>
      // Simple admin authentication check
      const adminPassword = 'bloodcenter2024'; // Change this to a secure password
      
      function checkAdminAccess() {
        const enteredPassword = prompt('Enter admin password:');
        if (enteredPassword !== adminPassword) {
          alert('Access denied');
          window.location.href = '/';
          return false;
        }
        return true;
      }
      
      // Check access on page load
      if (!checkAdminAccess()) {
        // Redirect handled in checkAdminAccess
      } else {
        // Load admin interface
        loadAdminInterface();
      }
      
      function loadAdminInterface() {
        const { useState, useEffect } = React;
        const { 
          Box, 
          Paper, 
          Typography, 
          Button, 
          CircularProgress,
          Alert,
          Grid,
          Tabs,
          Tab,
          Table,
          TableBody,
          TableCell,
          TableContainer,
          TableHead,
          TableRow,
          Chip,
          TextField,
          MenuItem,
          Pagination,
          AppBar,
          Toolbar,
          Container,
          Card,
          CardContent,
          ThemeProvider,
          createTheme
        } = MaterialUI;
        
        const theme = createTheme({
          palette: {
            primary: {
              main: '#1976d2',
            },
          },
        });
        
        function AdminApp() {
          const [activeTab, setActiveTab] = useState(0);
          const [isLoading, setIsLoading] = useState(false);
          const [status, setStatus] = useState('');
          const [conversations, setConversations] = useState([]);
          const [totalConversations, setTotalConversations] = useState(0);
          const [currentPage, setCurrentPage] = useState(1);
          const [pageSize] = useState(10);
          const [dateFilter, setDateFilter] = useState('');
          const [languageFilter, setLanguageFilter] = useState('');
          
          // Get API URL from current domain
          const API_URL = window.location.origin;
          
          const fetchChatHistory = async (page = 1, filters = {}) => {
            setIsLoading(true);
            try {
              const queryParams = new URLSearchParams({
                page: page.toString(),
                limit: pageSize.toString(),
                ...filters
              });

              const response = await fetch(`${API_URL}/admin/conversations?${queryParams}`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              setConversations(data.conversations || []);
              setTotalConversations(data.total || 0);
            } catch (error) {
              console.error('Error fetching chat history:', error);
              setStatus('Error loading chat history');
            } finally {
              setIsLoading(false);
            }
          };
          
          useEffect(() => {
            if (activeTab === 1) {
              const filters = {};
              if (dateFilter) filters.date = dateFilter;
              if (languageFilter) filters.language = languageFilter;
              fetchChatHistory(currentPage, filters);
            }
          }, [activeTab, currentPage, dateFilter, languageFilter]);
          
          const triggerDataSync = async (syncType) => {
            setIsLoading(true);
            setStatus('');

            try {
              const response = await fetch(`${API_URL}/admin/sync`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  sync_type: syncType,
                  data_source_type: 'both'
                }),
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              setStatus(`${syncType} sync started successfully`);
            } catch (error) {
              console.error('Error triggering sync:', error);
              setStatus('Error starting sync');
            } finally {
              setIsLoading(false);
            }
          };
          
          const checkKnowledgeBaseStatus = async () => {
            setIsLoading(true);
            setStatus('');

            try {
              const response = await fetch(`${API_URL}/admin/status`, {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              setStatus(`Status: ${data.status || 'Unknown'}`);
            } catch (error) {
              console.error('Error checking status:', error);
              setStatus('Error checking status');
            } finally {
              setIsLoading(false);
            }
          };
          
          const formatDate = (dateString) => {
            return new Date(dateString).toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          };

          const truncateText = (text, maxLength = 100) => {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
          };
          
          return React.createElement(ThemeProvider, { theme },
            React.createElement(Box, { sx: { minHeight: '100vh', backgroundColor: '#f5f5f5' } },
              // Header
              React.createElement(AppBar, { position: 'static', sx: { backgroundColor: '#1565c0' } },
                React.createElement(Toolbar, null,
                  React.createElement(Typography, { variant: 'h6', component: 'div', sx: { flexGrow: 1 } },
                    "America's Blood Centers - Admin Dashboard"
                  ),
                  React.createElement(Button, { 
                    color: 'inherit', 
                    onClick: () => window.location.href = '/',
                    sx: { ml: 2 }
                  }, "Back to Chat")
                )
              ),
              
              // Main Content
              React.createElement(Container, { maxWidth: 'xl', sx: { py: 4 } },
                // Welcome Card
                React.createElement(Card, { sx: { mb: 4 } },
                  React.createElement(CardContent, null,
                    React.createElement(Typography, { variant: 'h4', gutterBottom: true }, "Admin Dashboard"),
                    React.createElement(Typography, { variant: 'body1', color: 'textSecondary' }, 
                      "Manage your chatbot settings and view conversation history"
                    )
                  )
                ),
                
                // Tabs
                React.createElement(Paper, { sx: { mb: 3 } },
                  React.createElement(Tabs, { 
                    value: activeTab, 
                    onChange: (e, v) => setActiveTab(v),
                    sx: { borderBottom: 1, borderColor: 'divider' }
                  },
                    React.createElement(Tab, { label: 'Settings & Sync' }),
                    React.createElement(Tab, { label: 'Chat History' })
                  )
                ),
                
                // Settings Tab
                activeTab === 0 && React.createElement(Paper, { sx: { p: 4 } },
                  React.createElement(Typography, { variant: 'h5', gutterBottom: true }, "System Settings"),
                  React.createElement(Grid, { container: true, spacing: 3 },
                    React.createElement(Grid, { item: true, xs: 12, md: 6 },
                      React.createElement(Card, null,
                        React.createElement(CardContent, null,
                          React.createElement(Typography, { variant: 'h6', gutterBottom: true }, "Data Synchronization"),
                          React.createElement(Typography, { variant: 'body2', color: 'textSecondary', sx: { mb: 2 } },
                            "Sync knowledge base with latest data sources"
                          ),
                          React.createElement(Box, { sx: { display: 'flex', gap: 2, flexDirection: 'column' } },
                            React.createElement(Button, {
                              variant: 'contained',
                              onClick: () => triggerDataSync('manual'),
                              disabled: isLoading
                            }, "Manual Sync"),
                            React.createElement(Button, {
                              variant: 'contained',
                              onClick: () => triggerDataSync('daily'),
                              disabled: isLoading
                            }, "Daily Sync")
                          )
                        )
                      )
                    ),
                    React.createElement(Grid, { item: true, xs: 12, md: 6 },
                      React.createElement(Card, null,
                        React.createElement(CardContent, null,
                          React.createElement(Typography, { variant: 'h6', gutterBottom: true }, "System Status"),
                          React.createElement(Typography, { variant: 'body2', color: 'textSecondary', sx: { mb: 2 } },
                            "Check knowledge base and system health"
                          ),
                          React.createElement(Box, { sx: { display: 'flex', gap: 2, flexDirection: 'column' } },
                            React.createElement(Button, {
                              variant: 'outlined',
                              onClick: checkKnowledgeBaseStatus,
                              disabled: isLoading
                            }, "Check Status"),
                            React.createElement(Button, {
                              variant: 'outlined',
                              onClick: () => window.open('https://console.aws.amazon.com/bedrock/home#/knowledge-bases', '_blank')
                            }, "AWS Console")
                          )
                        )
                      )
                    )
                  ),
                  status && React.createElement(Alert, { severity: 'info', sx: { mt: 3 } }, status),
                  isLoading && React.createElement(Box, { sx: { display: 'flex', justifyContent: 'center', alignItems: 'center', mt: 3 } },
                    React.createElement(CircularProgress, { size: 24, sx: { mr: 1 } }),
                    React.createElement(Typography, { variant: 'body2', color: 'textSecondary' }, "Processing...")
                  )
                ),
                
                // Chat History Tab
                activeTab === 1 && React.createElement(Paper, { sx: { p: 4 } },
                  React.createElement(Typography, { variant: 'h5', gutterBottom: true }, "Chat History"),
                  
                  // Filters
                  React.createElement(Box, { sx: { display: 'flex', gap: 2, mb: 3, flexWrap: 'wrap' } },
                    React.createElement(TextField, {
                      label: 'Filter by date',
                      type: 'date',
                      value: dateFilter,
                      onChange: (e) => setDateFilter(e.target.value),
                      InputLabelProps: { shrink: true },
                      size: 'small',
                      sx: { minWidth: 150 }
                    }),
                    React.createElement(TextField, {
                      select: true,
                      label: 'Language',
                      value: languageFilter,
                      onChange: (e) => setLanguageFilter(e.target.value),
                      size: 'small',
                      sx: { minWidth: 120 }
                    },
                      React.createElement(MenuItem, { value: '' }, "All"),
                      React.createElement(MenuItem, { value: 'en' }, "English"),
                      React.createElement(MenuItem, { value: 'es' }, "Español")
                    )
                  ),
                  
                  // Table
                  React.createElement(TableContainer, { component: Paper, variant: 'outlined' },
                    React.createElement(Table, null,
                      React.createElement(TableHead, null,
                        React.createElement(TableRow, { sx: { backgroundColor: '#f5f5f5' } },
                          React.createElement(TableCell, null, React.createElement('strong', null, 'Question')),
                          React.createElement(TableCell, null, React.createElement('strong', null, 'Answer')),
                          React.createElement(TableCell, null, React.createElement('strong', null, 'Date')),
                          React.createElement(TableCell, null, React.createElement('strong', null, 'Language'))
                        )
                      ),
                      React.createElement(TableBody, null,
                        conversations.map((conversation, index) =>
                          React.createElement(TableRow, { key: conversation.id || index, hover: true },
                            React.createElement(TableCell, { sx: { maxWidth: 300 } },
                              React.createElement(Typography, { 
                                variant: 'body2', 
                                title: conversation.message 
                              }, truncateText(conversation.message || conversation.question, 80))
                            ),
                            React.createElement(TableCell, { sx: { maxWidth: 400 } },
                              React.createElement(Typography, { 
                                variant: 'body2', 
                                color: 'textSecondary',
                                title: conversation.response || conversation.answer 
                              }, truncateText(conversation.response || conversation.answer, 100))
                            ),
                            React.createElement(TableCell, null,
                              React.createElement(Typography, { variant: 'body2' },
                                formatDate(conversation.timestamp || conversation.created_at)
                              )
                            ),
                            React.createElement(TableCell, null,
                              React.createElement(Chip, {
                                label: conversation.language === 'es' ? 'Español' : 'English',
                                size: 'small',
                                color: conversation.language === 'es' ? 'secondary' : 'primary'
                              })
                            )
                          )
                        )
                      )
                    )
                  ),
                  
                  conversations.length === 0 && !isLoading && React.createElement(Box, { sx: { textAlign: 'center', py: 4 } },
                    React.createElement(Typography, { color: 'textSecondary' }, "No conversations found")
                  ),
                  
                  isLoading && React.createElement(Box, { sx: { display: 'flex', justifyContent: 'center', py: 4 } },
                    React.createElement(CircularProgress)
                  ),
                  
                  totalConversations > pageSize && React.createElement(Box, { sx: { display: 'flex', justifyContent: 'center', mt: 3 } },
                    React.createElement(Pagination, {
                      count: Math.ceil(totalConversations / pageSize),
                      page: currentPage,
                      onChange: (e, page) => setCurrentPage(page),
                      color: 'primary'
                    })
                  ),
                  
                  React.createElement(Box, { sx: { mt: 2, textAlign: 'center' } },
                    React.createElement(Typography, { variant: 'body2', color: 'textSecondary' },
                      `Showing ${conversations.length} of ${totalConversations} conversations`
                    )
                  )
                )
              )
            )
          );
        }
        
        // Render the admin app
        const root = ReactDOM.createRoot(document.getElementById('admin-root'));
        root.render(React.createElement(AdminApp));
      }
    </script>
  </body>
</html>