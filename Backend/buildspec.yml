version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
      python: 3.11
    commands:
      - echo "Installing AWS CDK CLI..."
      - npm install -g aws-cdk@latest
      - cd Backend
      - npm install

  pre_build:
    commands:
      - echo "=== Building TypeScript ==="
      - npm run build
      - echo "‚úÖ TypeScript build completed"
      - echo "=== Installing Lambda dependencies ==="
      - cd lambda/chat-lambda && pip install -r requirements.txt -t . && cd ../..
      - cd lambda/daily-sync-lambda && pip install -r requirements.txt -t . && cd ../..
      - cd lambda/sync-operations && pip install -r requirements.txt -t . && cd ../..
      - echo "‚úÖ Lambda dependencies installed"
      - echo "=== Bootstrapping CDK Environment ==="
      - |
        # Set default PROJECT_NAME for bootstrap if not provided
        if [ -z "$PROJECT_NAME" ]; then
          PROJECT_NAME="abc"
        fi
        cdk bootstrap --require-approval never \
          --context projectName="$PROJECT_NAME" \
          --context modelId="${MODEL_ID:-global.anthropic.claude-sonnet-4-5-20250929-v1:0}" \
          --context embeddingModelId="${EMBEDDING_MODEL_ID:-amazon.titan-embed-text-v1}"
      - echo "‚úÖ CDK Bootstrap completed"

  build:
    commands:
      - |
        if [ "$ACTION" = "destroy" ]; then
          echo "=== Destroying Stack ==="
          cdk destroy AmericasBloodCentersBedrockStack --force \
            --context projectName="$PROJECT_NAME" \
            --context modelId="$MODEL_ID" \
            --context embeddingModelId="$EMBEDDING_MODEL_ID"
          echo "‚úÖ Stack destroyed successfully"
        else
          echo "========================================="
          echo "Deploying America's Blood Centers Bedrock Chatbot"
          echo "========================================="
          
          echo "=== CDK Infrastructure Deployment ==="
          
          # Set default PROJECT_NAME if not provided
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="abc"
            echo "üîç Using default PROJECT_NAME: $PROJECT_NAME"
          else
            echo "üîç Using provided PROJECT_NAME: $PROJECT_NAME"
          fi
          
          cdk deploy AmericasBloodCentersBedrockStack --require-approval never \
            --context projectName="$PROJECT_NAME" \
            --context modelId="$MODEL_ID" \
            --context embeddingModelId="$EMBEDDING_MODEL_ID" \
            --outputs-file outputs.json
          
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: CDK deployment failed"
            exit 1
          fi
          
          echo "‚úÖ CDK deployment successful"
          
          echo "=== Extracting CDK Outputs ==="
          STACK_NAME="AmericasBloodCentersBedrockStack"
          DOCUMENTS_BUCKET=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.DocumentsBucketName // empty')
          KB_ID=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.KnowledgeBaseId // empty')
          API_URL=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.ApiGatewayUrl // empty')
          OPENSEARCH_ENDPOINT=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.OpenSearchCollectionEndpoint // empty')
          
          if [ -z "$DOCUMENTS_BUCKET" ] || [ -z "$KB_ID" ] || [ -z "$API_URL" ]; then
            echo "‚ùå ERROR: Failed to extract required outputs from CDK deployment"
            echo "Documents Bucket: $DOCUMENTS_BUCKET"
            echo "Knowledge Base ID: $KB_ID"
            echo "API URL: $API_URL"
            exit 1
          fi
          
          echo "‚úÖ Outputs extracted successfully"
          echo "  üìÅ Documents Bucket: $DOCUMENTS_BUCKET"
          echo "  üß† Knowledge Base ID: $KB_ID"
          echo "  üåê API Gateway URL: $API_URL"
          echo "  üîç OpenSearch Endpoint: $OPENSEARCH_ENDPOINT"
          
          echo ""
          echo "=== Starting Knowledge Base Ingestion (Background) ==="
          
          # Start sequential sync using Step Functions state machine
          echo "Starting Step Functions workflow for sequential sync..."
          
          # Get Step Functions State Machine ARN from CDK outputs
          STATE_MACHINE_ARN=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.SequentialSyncStateMachineArn // empty')
          
          if [ -n "$STATE_MACHINE_ARN" ] && [ "$STATE_MACHINE_ARN" != "empty" ]; then
            echo "‚úÖ Found Step Functions State Machine: $STATE_MACHINE_ARN"
            
            # Start Step Functions execution asynchronously
            EXECUTION_ARN=$(aws stepfunctions start-execution \
              --state-machine-arn "$STATE_MACHINE_ARN" \
              --name "deployment-sync-$(date +%s)" \
              --input '{"sync_type":"deployment","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' \
              --region "$CDK_DEFAULT_REGION" \
              --query 'executionArn' \
              --output text)
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Step Functions workflow started successfully"
              echo "üìä Execution ARN: $EXECUTION_ARN"
              echo "üîÑ Sync order: PDF Documents ‚Üí Daily Sync ‚Üí Website Content"
              echo "‚è±Ô∏è Workflow will handle all waiting and sequencing automatically"
              echo "üí∞ Cost optimized: Only pay for actual state transitions"
              echo "üéØ No Lambda timeout issues - can run for hours"
            else
              echo "‚ö†Ô∏è Failed to start Step Functions workflow, but continuing deployment"
            fi
          else
            echo "‚ö†Ô∏è Step Functions State Machine not found, skipping background sync"
          fi
          
          echo ""
          echo "=== Amplify App Setup ==="
          
          # Get Amplify App ID from CDK outputs
          AMPLIFY_APP_ID=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.AmplifyAppId // empty')
          
          if [ -n "$AMPLIFY_APP_ID" ] && [ "$AMPLIFY_APP_ID" != "empty" ]; then
            echo "‚úÖ Amplify App created via CDK: $AMPLIFY_APP_ID"
            echo "üì± Amplify App URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
          else
            echo "‚ö†Ô∏è Amplify App ID not found in CDK outputs"
          fi
          
          echo ""
          echo "=== Frontend Build and Automated Deployment ==="
          
          # Check if Frontend directory exists
          if [ -d "../Frontend" ]; then
            cd ../Frontend
            
            # Set up environment variables
            export PUBLIC_URL=""
            export GENERATE_SOURCEMAP=false
            echo "REACT_APP_API_BASE_URL=$API_URL" > .env.production
            echo "REACT_APP_CHAT_ENDPOINT=$API_URL" >> .env.production
            echo "REACT_APP_HEALTH_ENDPOINT=$API_URL" >> .env.production
            echo "REACT_APP_USER_POOL_ID=$(cat ../Backend/outputs.json | jq -r '.AmericasBloodCentersBedrockStack.AdminUserPoolId // empty')" >> .env.production
            echo "REACT_APP_USER_POOL_CLIENT_ID=$(cat ../Backend/outputs.json | jq -r '.AmericasBloodCentersBedrockStack.AdminUserPoolClientId // empty')" >> .env.production
            echo "REACT_APP_AWS_REGION=$CDK_DEFAULT_REGION" >> .env.production
            echo "PUBLIC_URL=" >> .env.production
            echo "GENERATE_SOURCEMAP=false" >> .env.production
            
            # Clean and build
            rm -rf build/ node_modules/.cache/
            npm install
            npm run build
            
            if [ ! -f "build/index.html" ]; then
              echo "‚ùå ERROR: Build failed - index.html not found!"
              exit 1
            fi
            
            if grep -q "%PUBLIC_URL%" build/index.html; then
              echo "‚ùå ERROR: Build incomplete - %PUBLIC_URL% not replaced!"
              exit 1
            fi
            
            echo "‚úÖ Build successful"
            
            # Create deployment package
            cd build
            zip -r ../build.zip . -x "*.DS_Store" "*.map"
            cd ..
            
            # Upload to builds bucket
            BUILD_KEY="builds/build-$(date +%s).zip"
            BUILDS_BUCKET=$(cat ../Backend/outputs.json | jq -r '.AmericasBloodCentersBedrockStack.BuildsBucketName // empty')
            
            if [ -n "$BUILDS_BUCKET" ] && [ "$BUILDS_BUCKET" != "empty" ]; then
              aws s3 cp build.zip "s3://$BUILDS_BUCKET/$BUILD_KEY"
              echo "‚úÖ Build artifact uploaded to S3: $BUILD_KEY"
              
              # Use direct Amplify deployment (no Lambda needed)
              aws amplify start-deployment \
                --app-id "$AMPLIFY_APP_ID" \
                --branch-name "main" \
                --source-url "s3://$BUILDS_BUCKET/$BUILD_KEY" \
                --region "$CDK_DEFAULT_REGION"
              echo "‚úÖ Direct Amplify deployment started"
              
              echo "üöÄ Automated deployment initiated"
              echo "üì± Amplify App URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
            else
              echo "‚ö†Ô∏è Builds bucket not found, skipping S3 upload"
            fi
            
            cd ../Backend
          else
            echo "‚ö†Ô∏è Frontend directory not found, skipping frontend deployment"
          fi
          
          echo ""
          echo "========================================="
          echo "‚úÖ Deployment Complete!"
          echo "========================================="
          echo "üß† Knowledge Base ID: $KB_ID"
          echo "ÔøΩ SDocuments Bucket: $DOCUMENTS_BUCKET"
          echo "üîç OpenSearch Endpoint: $OPENSEARCH_ENDPOINT"
          echo "üåê API Gateway URL: $API_URL"
          echo "ÔøΩ  Frontend URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
          echo "ÔøΩ Depnloyment Type: CDK-managed Amplify App"
          echo "‚è∞ Daily Sync: Automated at 2 AM UTC via EventBridge + Lambda"
          echo "========================================="
          echo ""
          echo "========================================="
          echo "ÔøΩ Neoxt Steps"
          echo "========================================="
          echo "1Ô∏è‚É£ Wait 5-10 minutes for ingestion jobs to complete"
          echo ""
          echo "2Ô∏è‚É£ Test the API:"
          echo "   curl -X POST $API_URL \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"message\":\"How many people donate blood?\",\"language\":\"en\"}'"
          echo ""
          echo "3Ô∏è‚É£ Test Spanish support:"
          echo "   curl -X POST $API_URL \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"message\":\"¬øCu√°ntas personas donan sangre?\",\"language\":\"es\"}'"
          echo ""
          echo "4Ô∏è‚É£ Monitor ingestion jobs:"
          echo "   aws bedrock-agent list-ingestion-jobs \\"
          echo "     --knowledge-base-id $KB_ID \\"
          echo "     --region $CDK_DEFAULT_REGION"
          echo ""
          echo "5Ô∏è‚É£ Add more documents:"
          echo "   aws s3 cp document.pdf s3://$DOCUMENTS_BUCKET/pdfs/"
          echo "   # Then trigger manual sync via admin dashboard"
          echo ""
          echo "üìä Monitor resources:"
          echo "  ‚Ä¢ Knowledge Base: https://console.aws.amazon.com/bedrock/home?region=${CDK_DEFAULT_REGION}#/knowledge-bases"
          echo "  ‚Ä¢ OpenSearch: https://console.aws.amazon.com/aos/home?region=${CDK_DEFAULT_REGION}#opensearch/collections"
          echo "  ‚Ä¢ S3 Bucket: https://s3.console.aws.amazon.com/s3/buckets/$DOCUMENTS_BUCKET"
          echo "  ‚Ä¢ Daily Sync Lambda: https://console.aws.amazon.com/lambda/home?region=${CDK_DEFAULT_REGION}#/functions"
          echo "  ‚Ä¢ EventBridge Rules: https://console.aws.amazon.com/events/home?region=${CDK_DEFAULT_REGION}#/rules"
          echo ""
          echo "ÔøΩ Estimanted monthly cost: \$8-20 (vs \$20+ for Q Business)"
          echo "üéØ Features: Dual data sources, bilingual support, automatic web crawling, markdown support"
          echo "üöÄ Frontend: Automatically deployed to Amplify (no GitHub required)"
          echo "‚è∞ Daily Sync: Fully automated - runs daily at 2 AM UTC for fresh blood supply data"
          echo ""
        fi

  post_build:
    commands:
      - echo "========================================="
      - echo "üéâ Deployment Complete"
      - echo "========================================="
      - |
        if [ "$ACTION" = "deploy" ]; then
          echo "‚úÖ Bedrock chatbot deployed successfully"
          echo "üìä Check CloudWatch Logs for Lambda execution details"
          echo "üß† Test Knowledge Base retrieval via the chat API"
          echo "üåê Monitor ingestion jobs in Bedrock console"
        else
          echo "‚úÖ Stack destroyed successfully"
        fi

artifacts:
  files:
    - "**/*"
  base-directory: "Backend/cdk.out"