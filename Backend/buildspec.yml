version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
      python: 3.11
    commands:
      - echo "Installing AWS CDK CLI..."
      - npm install -g aws-cdk@latest
      - cd Backend
      - npm install

  pre_build:
    commands:
      - echo "=== Building TypeScript ==="
      - npm run build
      - echo "‚úÖ TypeScript build completed"
      - echo "=== Installing Lambda dependencies ==="
      - cd chat-lambda && pip install -r requirements.txt -t . && cd ..
      - cd daily-sync-lambda && pip install -r requirements.txt -t . && cd ..
      - echo "‚úÖ Lambda dependencies installed"
      - echo "=== Bootstrapping CDK Environment ==="
      - |
        # Set default PROJECT_NAME for bootstrap if not provided
        if [ -z "$PROJECT_NAME" ]; then
          PROJECT_NAME="abc"
        fi
        cdk bootstrap --require-approval never \
          --context projectName="$PROJECT_NAME" \
          --context modelId="${MODEL_ID:-anthropic.claude-3-haiku-20240307-v1:0}" \
          --context embeddingModelId="${EMBEDDING_MODEL_ID:-amazon.titan-embed-text-v1}"
      - echo "‚úÖ CDK Bootstrap completed"

  build:
    commands:
      - |
        if [ "$ACTION" = "destroy" ]; then
          echo "=== Destroying Stack ==="
          cdk destroy AmericasBloodCentersBedrockStack --force \
            --context projectName="$PROJECT_NAME" \
            --context modelId="$MODEL_ID" \
            --context embeddingModelId="$EMBEDDING_MODEL_ID"
          echo "‚úÖ Stack destroyed successfully"
        else
          echo "========================================="
          echo "Deploying America's Blood Centers Bedrock Chatbot"
          echo "========================================="
          
          echo "=== CDK Infrastructure Deployment ==="
          
          # Set default PROJECT_NAME if not provided
          if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="abc"
            echo "üîç Using default PROJECT_NAME: $PROJECT_NAME"
          else
            echo "üîç Using provided PROJECT_NAME: $PROJECT_NAME"
          fi
          
          cdk deploy AmericasBloodCentersBedrockStack --require-approval never \
            --context projectName="$PROJECT_NAME" \
            --context modelId="$MODEL_ID" \
            --context embeddingModelId="$EMBEDDING_MODEL_ID" \
            --outputs-file outputs.json
          
          if [ $? -ne 0 ]; then
            echo "‚ùå ERROR: CDK deployment failed"
            exit 1
          fi
          
          echo "‚úÖ CDK deployment successful"
          
          echo "=== Extracting CDK Outputs ==="
          STACK_NAME="AmericasBloodCentersBedrockStack"
          DOCUMENTS_BUCKET=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.DocumentsBucketName // empty')
          KB_ID=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.KnowledgeBaseId // empty')
          API_URL=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.ApiGatewayUrl // empty')
          OPENSEARCH_ENDPOINT=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.OpenSearchCollectionEndpoint // empty')
          
          if [ -z "$DOCUMENTS_BUCKET" ] || [ -z "$KB_ID" ] || [ -z "$API_URL" ]; then
            echo "‚ùå ERROR: Failed to extract required outputs from CDK deployment"
            echo "Documents Bucket: $DOCUMENTS_BUCKET"
            echo "Knowledge Base ID: $KB_ID"
            echo "API URL: $API_URL"
            exit 1
          fi
          
          echo "‚úÖ Outputs extracted successfully"
          echo "  üìÅ Documents Bucket: $DOCUMENTS_BUCKET"
          echo "  üß† Knowledge Base ID: $KB_ID"
          echo "  üåê API Gateway URL: $API_URL"
          echo "  üîç OpenSearch Endpoint: $OPENSEARCH_ENDPOINT"
          
          echo ""
          echo "=== Starting Knowledge Base Ingestion ==="
          
          # Start ingestion for all data sources sequentially (not parallel)
          echo "Starting ingestion jobs for all data sources sequentially..."
          
          # Get all data sources
          DATA_SOURCES=$(aws bedrock-agent list-data-sources \
            --knowledge-base-id "$KB_ID" \
            --region "$CDK_DEFAULT_REGION" \
            --query 'dataSourceSummaries[].{name:name,id:dataSourceId}' \
            --output json)
          
          echo "Found data sources:"
          echo "$DATA_SOURCES" | jq -r '.[] | "  üìÑ \(.name) (ID: \(.id))"'
          
          # Start ingestion jobs sequentially with proper waits
          INGESTION_JOBS=""
          TOTAL_SOURCES=$(echo "$DATA_SOURCES" | jq length)
          CURRENT=0
          
          for row in $(echo "$DATA_SOURCES" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }
            
            DS_NAME=$(_jq '.name')
            DS_ID=$(_jq '.id')
            CURRENT=$((CURRENT + 1))
            
            echo ""
            echo "üöÄ Starting ingestion job $CURRENT/$TOTAL_SOURCES: $DS_NAME"
            
            JOB_ID=$(aws bedrock-agent start-ingestion-job \
              --knowledge-base-id "$KB_ID" \
              --data-source-id "$DS_ID" \
              --description "Sequential deployment ingestion of $DS_NAME" \
              --region "$CDK_DEFAULT_REGION" \
              --query 'ingestionJob.ingestionJobId' \
              --output text 2>/dev/null)
            
            if [ -n "$JOB_ID" ] && [ "$JOB_ID" != "None" ]; then
              echo "‚úÖ Started ingestion job: $JOB_ID"
              INGESTION_JOBS="$INGESTION_JOBS$DS_NAME: $JOB_ID\n"
              
              # Wait for job to start properly before starting next one
              echo "‚è≥ Waiting 30 seconds before starting next job..."
              sleep 30
              
              # Check job status
              JOB_STATUS=$(aws bedrock-agent get-ingestion-job \
                --knowledge-base-id "$KB_ID" \
                --data-source-id "$DS_ID" \
                --ingestion-job-id "$JOB_ID" \
                --region "$CDK_DEFAULT_REGION" \
                --query 'ingestionJob.status' \
                --output text 2>/dev/null || echo "UNKNOWN")
              
              echo "üìä Job status: $JOB_STATUS"
              
            else
              echo "‚ö†Ô∏è Failed to start ingestion job for $DS_NAME"
            fi
          done
          
          if [ -n "$INGESTION_JOBS" ]; then
            echo ""
            echo "üìä Started ingestion jobs:"
            echo -e "$INGESTION_JOBS"
            echo ""
            echo "‚è≥ Note: Ingestion jobs will continue running in background"
            echo "üìä Monitor progress in AWS Bedrock console"
          fi
          
          echo ""
          echo "=== Amplify App Setup ==="
          
          # Get Amplify App ID from CDK outputs
          AMPLIFY_APP_ID=$(cat outputs.json | jq -r '.AmericasBloodCentersBedrockStack.AmplifyAppId // empty')
          
          if [ -n "$AMPLIFY_APP_ID" ] && [ "$AMPLIFY_APP_ID" != "empty" ]; then
            echo "‚úÖ Amplify App created via CDK: $AMPLIFY_APP_ID"
            echo "üì± Amplify App URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
          else
            echo "‚ö†Ô∏è Amplify App ID not found in CDK outputs"
          fi
          
          echo ""
          echo "=== Frontend Build and Automated Deployment ==="
          
          # Check if Frontend directory exists
          if [ -d "../Frontend" ]; then
            cd ../Frontend
            
            # Set up environment variables
            export PUBLIC_URL=""
            export GENERATE_SOURCEMAP=false
            echo "REACT_APP_API_BASE_URL=$API_URL" > .env.production
            echo "REACT_APP_CHAT_ENDPOINT=$API_URL" >> .env.production
            echo "REACT_APP_HEALTH_ENDPOINT=$API_URL" >> .env.production
            echo "PUBLIC_URL=" >> .env.production
            echo "GENERATE_SOURCEMAP=false" >> .env.production
            
            # Clean and build
            rm -rf build/ node_modules/.cache/
            npm install
            npm run build
            
            if [ ! -f "build/index.html" ]; then
              echo "‚ùå ERROR: Build failed - index.html not found!"
              exit 1
            fi
            
            if grep -q "%PUBLIC_URL%" build/index.html; then
              echo "‚ùå ERROR: Build incomplete - %PUBLIC_URL% not replaced!"
              exit 1
            fi
            
            echo "‚úÖ Build successful"
            
            # Create deployment package
            cd build
            zip -r ../build.zip . -x "*.DS_Store" "*.map"
            cd ..
            
            # Upload to builds bucket
            BUILD_KEY="builds/build-$(date +%s).zip"
            BUILDS_BUCKET=$(cat ../Backend/outputs.json | jq -r '.AmericasBloodCentersBedrockStack.BuildsBucketName // empty')
            
            if [ -n "$BUILDS_BUCKET" ] && [ "$BUILDS_BUCKET" != "empty" ]; then
              aws s3 cp build.zip "s3://$BUILDS_BUCKET/$BUILD_KEY"
              echo "‚úÖ Build artifact uploaded to S3: $BUILD_KEY"
              
              # Use direct Amplify deployment (no Lambda needed)
              aws amplify start-deployment \
                --app-id "$AMPLIFY_APP_ID" \
                --branch-name "main" \
                --source-url "s3://$BUILDS_BUCKET/$BUILD_KEY" \
                --region "$CDK_DEFAULT_REGION"
              echo "‚úÖ Direct Amplify deployment started"
              
              echo "üöÄ Automated deployment initiated"
              echo "üì± Amplify App URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
            else
              echo "‚ö†Ô∏è Builds bucket not found, skipping S3 upload"
            fi
            
            cd ../Backend
          else
            echo "‚ö†Ô∏è Frontend directory not found, skipping frontend deployment"
          fi
          
          echo ""
          echo "========================================="
          echo "‚úÖ Deployment Complete!"
          echo "========================================="
          echo "üß† Knowledge Base ID: $KB_ID"
          echo "ÔøΩ SDocuments Bucket: $DOCUMENTS_BUCKET"
          echo "üîç OpenSearch Endpoint: $OPENSEARCH_ENDPOINT"
          echo "üåê API Gateway URL: $API_URL"
          echo "ÔøΩ  Frontend URL: https://main.$AMPLIFY_APP_ID.amplifyapp.com"
          echo "ÔøΩ Depnloyment Type: CDK-managed Amplify App"
          echo "‚è∞ Daily Sync: Automated at 2 AM UTC via EventBridge + Lambda"
          echo "========================================="
          echo ""
          echo "========================================="
          echo "ÔøΩ Neoxt Steps"
          echo "========================================="
          echo "1Ô∏è‚É£ Wait 5-10 minutes for ingestion jobs to complete"
          echo ""
          echo "2Ô∏è‚É£ Test the API:"
          echo "   curl -X POST $API_URL \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"message\":\"How many people donate blood?\",\"language\":\"en\"}'"
          echo ""
          echo "3Ô∏è‚É£ Test Spanish support:"
          echo "   curl -X POST $API_URL \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"message\":\"¬øCu√°ntas personas donan sangre?\",\"language\":\"es\"}'"
          echo ""
          echo "4Ô∏è‚É£ Monitor ingestion jobs:"
          echo "   aws bedrock-agent list-ingestion-jobs \\"
          echo "     --knowledge-base-id $KB_ID \\"
          echo "     --region $CDK_DEFAULT_REGION"
          echo ""
          echo "5Ô∏è‚É£ Add more documents:"
          echo "   aws s3 cp document.pdf s3://$DOCUMENTS_BUCKET/pdfs/"
          echo "   # Then trigger manual sync via admin dashboard"
          echo ""
          echo "üìä Monitor resources:"
          echo "  ‚Ä¢ Knowledge Base: https://console.aws.amazon.com/bedrock/home?region=${CDK_DEFAULT_REGION}#/knowledge-bases"
          echo "  ‚Ä¢ OpenSearch: https://console.aws.amazon.com/aos/home?region=${CDK_DEFAULT_REGION}#opensearch/collections"
          echo "  ‚Ä¢ S3 Bucket: https://s3.console.aws.amazon.com/s3/buckets/$DOCUMENTS_BUCKET"
          echo "  ‚Ä¢ Daily Sync Lambda: https://console.aws.amazon.com/lambda/home?region=${CDK_DEFAULT_REGION}#/functions"
          echo "  ‚Ä¢ EventBridge Rules: https://console.aws.amazon.com/events/home?region=${CDK_DEFAULT_REGION}#/rules"
          echo ""
          echo "ÔøΩ Estimanted monthly cost: \$8-20 (vs \$20+ for Q Business)"
          echo "üéØ Features: Dual data sources, bilingual support, automatic web crawling, markdown support"
          echo "üöÄ Frontend: Automatically deployed to Amplify (no GitHub required)"
          echo "‚è∞ Daily Sync: Fully automated - runs daily at 2 AM UTC for fresh blood supply data"
          echo ""
        fi

  post_build:
    commands:
      - echo "========================================="
      - echo "üéâ Deployment Complete"
      - echo "========================================="
      - |
        if [ "$ACTION" = "deploy" ]; then
          echo "‚úÖ Bedrock chatbot deployed successfully"
          echo "üìä Check CloudWatch Logs for Lambda execution details"
          echo "üß† Test Knowledge Base retrieval via the chat API"
          echo "üåê Monitor ingestion jobs in Bedrock console"
        else
          echo "‚úÖ Stack destroyed successfully"
        fi

artifacts:
  files:
    - "**/*"
  base-directory: "Backend/cdk.out"